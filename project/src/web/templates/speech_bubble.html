<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speech Bubble Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: black;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #bubble-image {
            position: absolute;
            width: 100%;
            height: auto;
            left: 0;
            top: 0;
            opacity: 0;
            transition: opacity 0.3s ease, top 0.2s ease;
        }

        #bubble-image.visible {
            opacity: 1;
        }

        #text-container {
            position: absolute;
            width: 85%;
            left: 7.5%;
            top: 40%;
            transform: translateY(-50%);
            text-align: center;
            padding: 20px 30px;
            opacity: 0;
            transition: opacity 0.3s ease, top 0.2s ease;
        }

        #text-container.visible {
            opacity: 1;
        }

        #text {
            font-family: 'Hiragino Kaku Gothic ProN', 'Arial', sans-serif;
            font-size: 8vw;
            font-weight: bold;
            color: black;
            word-wrap: break-word;
            line-height: 1.1;
        }

        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        #connection-status.connected {
            color: green;
        }

        #connection-status.disconnected {
            color: red;
        }

        /* Language Selection Modal */
        #language-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #language-modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: white;
            padding: 40px 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .language-selector {
            margin-bottom: 25px;
            text-align: left;
        }

        .language-selector label {
            display: block;
            color: #666;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 500;
        }

        .language-selector select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: white;
            color: #333;
            cursor: pointer;
        }

        .language-selector select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        #start-button {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        #start-button:hover {
            background-color: #45a049;
        }

        #start-button:active {
            background-color: #3d8b40;
        }

        #start-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading-message {
            display: none;
            color: #666;
            margin-top: 15px;
            font-size: 16px;
        }

        .loading-message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Language Selection Modal -->
    <div id="language-modal">
        <div class="modal-content">
            <h2>üåê Ë®ÄË™ûË®≠ÂÆö</h2>

            <div class="language-selector">
                <label for="source-lang">ÁøªË®≥ÂÖÉË®ÄË™û:</label>
                <select id="source-lang">
                    <option value="ja-JP">Êó•Êú¨Ë™û</option>
                    <option value="en-US">English</option>
                    <option value="zh-CN">‰∏≠ÊñáÔºàÁÆÄ‰ΩìÔºâ</option>
                    <option value="zh-TW">‰∏≠ÊñáÔºàÁπÅÈ´îÔºâ</option>
                    <option value="ko-KR">ÌïúÍµ≠Ïñ¥</option>
                    <option value="fr-FR">Fran√ßais</option>
                    <option value="de-DE">Deutsch</option>
                    <option value="es-ES">Espa√±ol</option>
                </select>
            </div>

            <div class="language-selector">
                <label for="target-lang">ÁøªË®≥ÂÖàË®ÄË™û:</label>
                <select id="target-lang">
                    <option value="en-US" selected>English</option>
                    <option value="ja-JP">Êó•Êú¨Ë™û</option>
                    <option value="zh-CN">‰∏≠ÊñáÔºàÁÆÄ‰ΩìÔºâ</option>
                    <option value="zh-TW">‰∏≠ÊñáÔºàÁπÅÈ´îÔºâ</option>
                    <option value="ko-KR">ÌïúÍµ≠Ïñ¥</option>
                    <option value="fr-FR">Fran√ßais</option>
                    <option value="de-DE">Deutsch</option>
                    <option value="es-ES">Espa√±ol</option>
                </select>
            </div>

            <button id="start-button">„Ç∑„Çπ„ÉÜ„É†„ÇíÈñãÂßã</button>
            <div class="loading-message" id="loading-message">„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï‰∏≠...</div>
        </div>
    </div>

    <div id="connection-status" class="disconnected">Êé•Á∂ö‰∏≠...</div>
    <div id="container">
        <img id="bubble-image" src="/static/images/speech-bubble1.png" alt="Speech Bubble">
        <div id="text-container">
            <div id="text"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        const bubbleImage = document.getElementById('bubble-image');
        const textContainer = document.getElementById('text-container');
        const textElement = document.getElementById('text');
        const statusElement = document.getElementById('connection-status');

        let bubbleImageHeight = 0;
        let containerHeight = window.innerHeight;
        let currentText = '';

        // „Éá„Éê„Ç§„ÇπÂà•„ÅÆÊúÄÂ∞è„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ë®≠ÂÆö
        const MIN_FONT_SIZE_DESKTOP = 100;  // PC: 100px
        const MIN_FONT_SIZE_MOBILE = 18;    // „Çπ„Éû„Éõ: 18px (Apple HIG, Material Design, WCAGÊ∫ñÊã†)
        const MOBILE_BREAKPOINT = 768;      // 768px‰ª•‰∏ã„Çí„É¢„Éê„Ç§„É´„Å®Âà§ÂÆö

        /**
         * „Éá„Éê„Ç§„Çπ„Åå„É¢„Éê„Ç§„É´„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
         */
        function isMobile() {
            return window.innerWidth <= MOBILE_BREAKPOINT;
        }

        /**
         * „ÉÜ„Ç≠„Çπ„Éà„ÅÆÈï∑„Åï„Å´Âøú„Åò„Å¶ÊúÄÈÅ©„Å™„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
         */
        function calculateFontSize(text) {
            const textLength = text.length;
            const minSize = isMobile() ? MIN_FONT_SIZE_MOBILE : MIN_FONT_SIZE_DESKTOP;

            let fontSize;

            // ÊñáÂ≠óÊï∞„Å´Âøú„Åò„Å¶ÊÆµÈöéÁöÑ„Å´Ë™øÊï¥
            if (textLength <= 20) {
                // Áü≠Êñá: 8vw
                fontSize = Math.max(window.innerWidth * 0.08, minSize);
            } else if (textLength <= 40) {
                // ‰∏≠Êñá: 6vw
                fontSize = Math.max(window.innerWidth * 0.06, minSize);
            } else if (textLength <= 60) {
                // Èï∑Êñá: 5vw
                fontSize = Math.max(window.innerWidth * 0.05, minSize);
            } else {
                // Ë∂ÖÈï∑Êñá: ÊúÄÂ∞è„Çµ„Ç§„Ç∫Âõ∫ÂÆö
                fontSize = minSize;
            }

            return fontSize;
        }

        /**
         * „ÉÜ„Ç≠„Çπ„Éà„ÅÆË°åÊï∞„ÇíË®àÁÆó
         */
        function getLineCount() {
            // „ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†„ÅÆÈ´ò„Åï„Çí„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÅßÂâ≤„Å£„Å¶Ë°åÊï∞„ÇíË®àÁÆó
            const lineHeight = parseFloat(window.getComputedStyle(textElement).lineHeight);
            const textHeight = textElement.offsetHeight;
            const lines = Math.round(textHeight / lineHeight);
            return lines;
        }

        /**
         * Ë°åÊï∞„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å™Âêπ„ÅçÂá∫„ÅóÁîªÂÉè„ÇíÈÅ∏Êäû
         */
        function selectBubbleImage(lines) {
            if (lines <= 1) {
                return '/static/images/speech-bubble1.png';  // 1Ë°åÁî®
            } else if (lines === 2) {
                return '/static/images/speech-bubble2.png';  // 2Ë°åÁî®
            } else {
                return '/static/images/speech-bubble3.png';  // 3Ë°å‰ª•‰∏äÁî®
            }
        }

        /**
         * „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÊõ¥Êñ∞„Åó„ÄÅÂêπ„ÅçÂá∫„ÅóÁîªÂÉè„ÇíÂàá„ÇäÊõø„Åà„Çã
         */
        function updateFontSize(text) {
            const fontSize = calculateFontSize(text);
            textElement.style.fontSize = fontSize + 'px';

            // Ê¨°„ÅÆ„Éï„É¨„Éº„É†„ÅßË°åÊï∞„ÇíË®àÁÆóÔºàDOM„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÂæåÔºâ
            requestAnimationFrame(() => {
                const lines = getLineCount();
                const newBubbleImage = selectBubbleImage(lines);

                // Âêπ„ÅçÂá∫„ÅóÁîªÂÉè„ÇíÂàá„ÇäÊõø„Åà
                if (bubbleImage.src !== window.location.origin + newBubbleImage) {
                    bubbleImage.src = newBubbleImage;
                    console.log(`Switched to: ${newBubbleImage} (${lines} lines)`);
                }

                console.log(`Text length: ${text.length}, Font size: ${fontSize}px, Lines: ${lines}, Device: ${isMobile() ? 'Mobile' : 'Desktop'}`);
            });
        }

        // ÁîªÂÉè„ÅÆÈ´ò„Åï„ÇíÂèñÂæóÔºàÁîªÂÉè„ÅåË™≠„ÅøËæº„Åæ„Çå„Çã„Åü„Å≥„Å´Êõ¥Êñ∞Ôºâ
        bubbleImage.onload = function() {
            bubbleImageHeight = bubbleImage.offsetHeight;
            // ÁèæÂú®„ÅÆ‰ΩçÁΩÆ„Åß„ÉÜ„Ç≠„Çπ„Éà‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
            const currentY = parseInt(bubbleImage.style.top) || 0;
            updateTextPosition(currentY);
            console.log(`Bubble image loaded. Height: ${bubbleImageHeight}px`);
        };

        // Êé•Á∂öÁä∂ÊÖã„ÅÆÁÆ°ÁêÜ
        socket.on('connect', () => {
            console.log('Connected to server');
            statusElement.textContent = 'Êé•Á∂öÊ∏à„Åø';
            statusElement.className = 'connected';
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 2000);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            statusElement.textContent = 'Êé•Á∂öÂàáÊñ≠';
            statusElement.className = 'disconnected';
            statusElement.style.display = 'block';
        });

        // „ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞„Ç§„Éô„É≥„Éà
        socket.on('update_text', (data) => {
            console.log('Received text:', data.text);
            currentText = data.text;
            textElement.textContent = data.text;

            // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíËá™ÂãïË™øÊï¥
            updateFontSize(data.text);

            bubbleImage.classList.add('visible');
            textContainer.classList.add('visible');
        });

        // ‰ΩçÁΩÆÊõ¥Êñ∞„Ç§„Éô„É≥„Éà
        socket.on('update_position', (data) => {
            console.log('Received position:', data.y);
            updateTextPosition(data.y);
        });

        // ÈùûË°®Á§∫„Ç§„Éô„É≥„Éà
        socket.on('hide_bubble', () => {
            console.log('Hiding bubble');
            bubbleImage.classList.remove('visible');
            textContainer.classList.remove('visible');
        });

        // Ë°®Á§∫„Ç§„Éô„É≥„Éà
        socket.on('show_bubble', () => {
            console.log('Showing bubble');
            bubbleImage.classList.add('visible');
            textContainer.classList.add('visible');
        });

        // ‰ΩçÁΩÆÊõ¥Êñ∞Èñ¢Êï∞
        function updateTextPosition(newY) {
            bubbleImage.style.top = newY + 'px';

            // Âêπ„ÅçÂá∫„ÅóÁîªÂÉè„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„Å¶„ÉÜ„Ç≠„Çπ„Éà‰ΩçÁΩÆ„ÇíË™øÊï¥
            let textYOffset;
            if (bubbleImage.src.includes('speech-bubble2.png')) {
                // 2Ë°åÁî®: ‰∏≠Â§Æ
                textYOffset = bubbleImageHeight / 2;
            } else if (bubbleImage.src.includes('speech-bubble3.png')) {
                // 3Ë°å‰ª•‰∏äÁî®: ‰∏≠Â§Æ
                textYOffset = bubbleImageHeight / 2;
            } else {
                // 1Ë°åÁî®: Â∞ë„Åó‰∏äÔºà40%„ÅÆ‰ΩçÁΩÆÔºâ
                textYOffset = bubbleImageHeight * 0.4;
            }

            const textY = newY + textYOffset;
            textContainer.style.top = textY + 'px';
        }

        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÂØæÂøú
        window.addEventListener('resize', () => {
            containerHeight = window.innerHeight;
            if (bubbleImage.complete) {
                bubbleImageHeight = bubbleImage.offsetHeight;
            }

            // „ÉÜ„Ç≠„Çπ„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÂÜçË®àÁÆó
            if (currentText) {
                updateFontSize(currentText);
            }
        });

        // ÂàùÊúüÁä∂ÊÖã„ÅßÊé•Á∂öÁ¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏
        socket.emit('client_ready', {
            screen_width: window.innerWidth,
            screen_height: window.innerHeight
        });

        // Ë®ÄË™ûÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÅÆÂá¶ÁêÜ
        const languageModal = document.getElementById('language-modal');
        const sourceLangSelect = document.getElementById('source-lang');
        const targetLangSelect = document.getElementById('target-lang');
        const startButton = document.getElementById('start-button');
        const loadingMessage = document.getElementById('loading-message');

        // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        startButton.addEventListener('click', () => {
            const sourceLang = sourceLangSelect.value;
            const targetLang = targetLangSelect.value;

            // Âêå„ÅòË®ÄË™û„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (sourceLang === targetLang) {
                alert('ÁøªË®≥ÂÖÉ„Å®ÁøªË®≥ÂÖà„Å´Áï∞„Å™„ÇãË®ÄË™û„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„ÄÅ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            startButton.disabled = true;
            loadingMessage.classList.add('visible');

            // „Çµ„Éº„Éê„Éº„Å´Ë®ÄË™ûÈÅ∏Êäû„ÇíÈÄÅ‰ø°
            socket.emit('select_language', {
                source_lang: sourceLang,
                target_lang: targetLang
            });
        });

        // „Ç∑„Çπ„ÉÜ„É†Ëµ∑ÂãïÂÆå‰∫Ü„Ç§„Éô„É≥„Éà
        socket.on('system_started', (data) => {
            console.log('System started:', data);

            // „É¢„Éº„ÉÄ„É´„ÇíÈùûË°®Á§∫
            languageModal.classList.add('hidden');

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈùûË°®Á§∫
            loadingMessage.classList.remove('visible');
            startButton.disabled = false;

            console.log(`Language set to: ${data.source_lang} -> ${data.target_lang}`);
        });
    </script>
</body>
</html>
