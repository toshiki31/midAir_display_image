<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speech Bubble Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: black;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #bubble-image {
            position: absolute;
            width: 100%;
            height: auto;
            left: 0;
            top: 0;
            opacity: 0;
            transition: opacity 0.3s ease, top 0.2s ease;
        }

        #bubble-image.visible {
            opacity: 1;
        }

        #text-container {
            position: absolute;
            width: 85%;
            left: 7.5%;
            top: 40%;
            transform: translateY(-50%);
            text-align: center;
            padding: 20px 30px;
            opacity: 0;
            transition: opacity 0.3s ease, top 0.2s ease;
        }

        #text-container.visible {
            opacity: 1;
        }

        #text {
            font-family: 'Hiragino Kaku Gothic ProN', 'Arial', sans-serif;
            font-size: 8vw;
            font-weight: bold;
            color: black;
            word-wrap: break-word;
            line-height: 1.1;
        }

        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        #connection-status.connected {
            color: green;
        }

        #connection-status.disconnected {
            color: red;
        }
    </style>
</head>
<body>
    <div id="connection-status" class="disconnected">接続中...</div>
    <div id="container">
        <img id="bubble-image" src="/static/images/speech-bubble1.png" alt="Speech Bubble">
        <div id="text-container">
            <div id="text"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        const bubbleImage = document.getElementById('bubble-image');
        const textContainer = document.getElementById('text-container');
        const textElement = document.getElementById('text');
        const statusElement = document.getElementById('connection-status');

        let bubbleImageHeight = 0;
        let containerHeight = window.innerHeight;
        let currentText = '';

        // デバイス別の最小フォントサイズ設定
        const MIN_FONT_SIZE_DESKTOP = 100;  // PC: 100px
        const MIN_FONT_SIZE_MOBILE = 18;    // スマホ: 18px (Apple HIG, Material Design, WCAG準拠)
        const MOBILE_BREAKPOINT = 768;      // 768px以下をモバイルと判定

        /**
         * デバイスがモバイルかどうかを判定
         */
        function isMobile() {
            return window.innerWidth <= MOBILE_BREAKPOINT;
        }

        /**
         * テキストの長さに応じて最適なフォントサイズを計算
         */
        function calculateFontSize(text) {
            const textLength = text.length;
            const minSize = isMobile() ? MIN_FONT_SIZE_MOBILE : MIN_FONT_SIZE_DESKTOP;

            let fontSize;

            // 文字数に応じて段階的に調整
            if (textLength <= 20) {
                // 短文: 8vw
                fontSize = Math.max(window.innerWidth * 0.08, minSize);
            } else if (textLength <= 40) {
                // 中文: 6vw
                fontSize = Math.max(window.innerWidth * 0.06, minSize);
            } else if (textLength <= 60) {
                // 長文: 5vw
                fontSize = Math.max(window.innerWidth * 0.05, minSize);
            } else {
                // 超長文: 最小サイズ固定
                fontSize = minSize;
            }

            return fontSize;
        }

        /**
         * テキストの行数を計算
         */
        function getLineCount() {
            // テキスト要素の高さをフォントサイズで割って行数を計算
            const lineHeight = parseFloat(window.getComputedStyle(textElement).lineHeight);
            const textHeight = textElement.offsetHeight;
            const lines = Math.round(textHeight / lineHeight);
            return lines;
        }

        /**
         * 行数に応じて適切な吹き出し画像を選択
         */
        function selectBubbleImage(lines) {
            if (lines <= 1) {
                return '/static/images/speech-bubble1.png';  // 1行用
            } else if (lines === 2) {
                return '/static/images/speech-bubble2.png';  // 2行用
            } else {
                return '/static/images/speech-bubble3.png';  // 3行以上用
            }
        }

        /**
         * テキストのフォントサイズを更新し、吹き出し画像を切り替える
         */
        function updateFontSize(text) {
            const fontSize = calculateFontSize(text);
            textElement.style.fontSize = fontSize + 'px';

            // 次のフレームで行数を計算（DOMが更新された後）
            requestAnimationFrame(() => {
                const lines = getLineCount();
                const newBubbleImage = selectBubbleImage(lines);

                // 吹き出し画像を切り替え
                if (bubbleImage.src !== window.location.origin + newBubbleImage) {
                    bubbleImage.src = newBubbleImage;
                    console.log(`Switched to: ${newBubbleImage} (${lines} lines)`);
                }

                console.log(`Text length: ${text.length}, Font size: ${fontSize}px, Lines: ${lines}, Device: ${isMobile() ? 'Mobile' : 'Desktop'}`);
            });
        }

        // 画像の高さを取得（画像が読み込まれるたびに更新）
        bubbleImage.onload = function() {
            bubbleImageHeight = bubbleImage.offsetHeight;
            // 現在の位置でテキスト位置を更新
            const currentY = parseInt(bubbleImage.style.top) || 0;
            updateTextPosition(currentY);
            console.log(`Bubble image loaded. Height: ${bubbleImageHeight}px`);
        };

        // 接続状態の管理
        socket.on('connect', () => {
            console.log('Connected to server');
            statusElement.textContent = '接続済み';
            statusElement.className = 'connected';
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 2000);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            statusElement.textContent = '接続切断';
            statusElement.className = 'disconnected';
            statusElement.style.display = 'block';
        });

        // テキスト更新イベント
        socket.on('update_text', (data) => {
            console.log('Received text:', data.text);
            currentText = data.text;
            textElement.textContent = data.text;

            // フォントサイズを自動調整
            updateFontSize(data.text);

            bubbleImage.classList.add('visible');
            textContainer.classList.add('visible');
        });

        // 位置更新イベント
        socket.on('update_position', (data) => {
            console.log('Received position:', data.y);
            updateTextPosition(data.y);
        });

        // 非表示イベント
        socket.on('hide_bubble', () => {
            console.log('Hiding bubble');
            bubbleImage.classList.remove('visible');
            textContainer.classList.remove('visible');
        });

        // 表示イベント
        socket.on('show_bubble', () => {
            console.log('Showing bubble');
            bubbleImage.classList.add('visible');
            textContainer.classList.add('visible');
        });

        // 位置更新関数
        function updateTextPosition(newY) {
            bubbleImage.style.top = newY + 'px';

            // 吹き出し画像の種類に応じてテキスト位置を調整
            let textYOffset;
            if (bubbleImage.src.includes('speech-bubble2.png')) {
                // 2行用: 中央
                textYOffset = bubbleImageHeight / 2;
            } else if (bubbleImage.src.includes('speech-bubble3.png')) {
                // 3行以上用: 中央
                textYOffset = bubbleImageHeight / 2;
            } else {
                // 1行用: 少し上（40%の位置）
                textYOffset = bubbleImageHeight * 0.4;
            }

            const textY = newY + textYOffset;
            textContainer.style.top = textY + 'px';
        }

        // ウィンドウリサイズ対応
        window.addEventListener('resize', () => {
            containerHeight = window.innerHeight;
            if (bubbleImage.complete) {
                bubbleImageHeight = bubbleImage.offsetHeight;
            }

            // テキストが表示されている場合、フォントサイズを再計算
            if (currentText) {
                updateFontSize(currentText);
            }
        });

        // 初期状態で接続確認メッセージ
        socket.emit('client_ready', {
            screen_width: window.innerWidth,
            screen_height: window.innerHeight
        });
    </script>
</body>
</html>
