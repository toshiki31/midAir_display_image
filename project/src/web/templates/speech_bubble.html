<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Speech Bubble Display</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: black;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      #container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      #bubble-image {
        position: absolute;
        width: 100%;
        height: auto;
        left: 0;
        top: 0;
        opacity: 0;
        transition: opacity 0.3s ease, top 0.2s ease;
      }

      #bubble-image.visible {
        opacity: 1;
      }

      #text-container {
        position: absolute;
        width: 85%;
        left: 7.5%;
        top: 40%;
        transform: translateY(-50%);
        text-align: center;
        padding: 20px 30px;
        opacity: 0;
        transition: opacity 0.3s ease, top 0.2s ease;
      }

      #text-container.visible {
        opacity: 1;
      }

      #text {
        font-family: "Hiragino Kaku Gothic ProN", "Arial", sans-serif;
        font-size: 8vw;
        font-weight: bold;
        color: black;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.1;
      }

      #connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
      }

      #connection-status.connected {
        color: green;
      }

      #connection-status.disconnected {
        color: red;
      }

      /* Language Selection Modal */
      #language-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      #language-modal.hidden {
        display: none;
      }

      .modal-content {
        background-color: white;
        padding: 40px 30px;
        border-radius: 20px;
        max-width: 500px;
        width: 90%;
        text-align: center;
      }

      .modal-content h2 {
        color: #333;
        margin-bottom: 30px;
        font-size: 24px;
      }

      .language-selector {
        margin-bottom: 25px;
        text-align: left;
      }

      .language-selector label {
        display: block;
        color: #666;
        margin-bottom: 8px;
        font-size: 16px;
        font-weight: 500;
      }

      .language-selector select {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: white;
        color: #333;
        cursor: pointer;
      }

      .language-selector select:focus {
        outline: none;
        border-color: #4caf50;
      }

      #start-button {
        width: 100%;
        padding: 18px;
        font-size: 20px;
        font-weight: bold;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s;
      }

      #start-button:hover {
        background-color: #45a049;
      }

      #start-button:active {
        background-color: #3d8b40;
      }

      #start-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .loading-message {
        display: none;
        color: #666;
        margin-top: 15px;
        font-size: 16px;
      }

      .loading-message.visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Language Selection Modal -->
    <div id="language-modal">
      <div class="modal-content">
        <h2>ğŸŒ è¨€èªè¨­å®š</h2>

        <div class="language-selector">
          <label for="source-lang">ç¿»è¨³å…ƒè¨€èª:</label>
          <select id="source-lang">
            <option value="ja-JP">æ—¥æœ¬èª</option>
            <option value="en-US">English</option>
            <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
            <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
            <option value="ko-KR">í•œêµ­ì–´</option>
            <option value="fr-FR">FranÃ§ais</option>
            <option value="de-DE">Deutsch</option>
            <option value="es-ES">EspaÃ±ol</option>
          </select>
        </div>

        <div class="language-selector">
          <label for="target-lang">ç¿»è¨³å…ˆè¨€èª:</label>
          <select id="target-lang">
            <option value="en-US" selected>English</option>
            <option value="ja-JP">æ—¥æœ¬èª</option>
            <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
            <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
            <option value="ko-KR">í•œêµ­ì–´</option>
            <option value="fr-FR">FranÃ§ais</option>
            <option value="de-DE">Deutsch</option>
            <option value="es-ES">EspaÃ±ol</option>
          </select>
        </div>

        <button id="start-button">ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹</button>
        <div class="loading-message" id="loading-message">
          ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ä¸­...
        </div>
      </div>
    </div>

    <div id="connection-status" class="disconnected">æ¥ç¶šä¸­...</div>
    <div id="container">
      <img
        id="bubble-image"
        src="/static/images/speech-bubble1.png"
        alt="Speech Bubble"
      />
      <div id="text-container">
        <div id="text"></div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const socket = io();
      const bubbleImage = document.getElementById("bubble-image");
      const textContainer = document.getElementById("text-container");
      const textElement = document.getElementById("text");
      const statusElement = document.getElementById("connection-status");

      let bubbleImageHeight = 0;
      let containerHeight = window.innerHeight;
      let currentText = "";

      // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºè¨­å®š
      const MIN_FONT_SIZE_DESKTOP = 100; // PC: 100px
      const FIXED_FONT_SIZE_MOBILE = 28; // ã‚¹ãƒãƒ›: 28pxå›ºå®š
      const MOBILE_BREAKPOINT = 768; // 768pxä»¥ä¸‹ã‚’ãƒ¢ãƒã‚¤ãƒ«ã¨åˆ¤å®š

      /**
       * ãƒ‡ãƒã‚¤ã‚¹ãŒãƒ¢ãƒã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®š
       */
      function isMobile() {
        return window.innerWidth <= MOBILE_BREAKPOINT;
      }

      /**
       * ãƒ†ã‚­ã‚¹ãƒˆã®é•·ã•ã«å¿œã˜ã¦æœ€é©ãªãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—
       */
      function calculateFontSize(text) {
        // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯å›ºå®šã‚µã‚¤ã‚º
        if (isMobile()) {
          return FIXED_FONT_SIZE_MOBILE;
        }

        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®å ´åˆã¯æ–‡å­—æ•°ã«å¿œã˜ã¦èª¿æ•´
        const textLength = text.length;
        let fontSize;

        if (textLength <= 20) {
          // çŸ­æ–‡: 8vw
          fontSize = Math.max(window.innerWidth * 0.08, MIN_FONT_SIZE_DESKTOP);
        } else if (textLength <= 40) {
          // ä¸­æ–‡: 6vw
          fontSize = Math.max(window.innerWidth * 0.06, MIN_FONT_SIZE_DESKTOP);
        } else if (textLength <= 60) {
          // é•·æ–‡: 5vw
          fontSize = Math.max(window.innerWidth * 0.05, MIN_FONT_SIZE_DESKTOP);
        } else {
          // è¶…é•·æ–‡: æœ€å°ã‚µã‚¤ã‚ºå›ºå®š
          fontSize = MIN_FONT_SIZE_DESKTOP;
        }

        return fontSize;
      }

      /**
       * ãƒ†ã‚­ã‚¹ãƒˆã®è¡Œæ•°ã‚’è¨ˆç®—
       */
      function getLineCount() {
        // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã®é«˜ã•ã‚’ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã§å‰²ã£ã¦è¡Œæ•°ã‚’è¨ˆç®—
        const computedStyle = window.getComputedStyle(textElement);
        const lineHeight = parseFloat(computedStyle.lineHeight);
        const textHeight = textElement.offsetHeight;
        // æœ€å°1è¡Œã‚’ä¿è¨¼ã—ã€åˆ‡ã‚Šä¸Šã’ã§è¨ˆç®—
        const lines = Math.max(1, Math.ceil(textHeight / lineHeight));
        return lines;
      }

      /**
       * è¡Œæ•°ã«å¿œã˜ã¦é©åˆ‡ãªå¹ãå‡ºã—ç”»åƒã‚’é¸æŠ
       */
      function selectBubbleImage(lines) {
        if (lines <= 1) {
          return "/static/images/speech-bubble1.png"; // 1è¡Œç”¨
        } else if (lines === 2) {
          return "/static/images/speech-bubble2.png"; // 2è¡Œç”¨
        } else {
          return "/static/images/speech-bubble3.png"; // 3è¡Œä»¥ä¸Šç”¨
        }
      }

      /**
       * ãƒ†ã‚­ã‚¹ãƒˆãŒæœ€å¤§è¡Œæ•°ã‚’è¶…ãˆã‚‹å ´åˆã€å¥èª­ç‚¹ã§åˆ‡ã‚Šè©°ã‚ã‚‹
       * æœ€æ–°ã®å®Œçµã—ãŸæ–‡ã‚’å„ªå…ˆã—ã¦è¡¨ç¤º
       */
      function truncateTextToMaxLines(text) {
        const MAX_LINES = 3;

        if (!text || text.length === 0) {
          return "";
        }

        // ä¸€æ™‚çš„ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã—ã¦è¡Œæ•°ã‚’æ¸¬å®š
        textElement.textContent = text;

        // ã™ã§ã«åˆ¶é™å†…ã§ã‚ã‚Œã°ãã®ã¾ã¾è¿”ã™
        const lineCount = getLineCount();
        if (lineCount <= MAX_LINES) {
          return text;
        }

        console.log(
          `Text overflow: ${lineCount} lines > ${MAX_LINES}. Truncating...`
        );

        // å¥èª­ç‚¹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ—¥æœ¬èªã¨è‹±èªï¼‰
        const punctuationMarks = [
          "ã€‚",
          "ï¼",
          "ï¼Ÿ",
          "ï¼",
          ".",
          "!",
          "?",
          "ã€",
          ",",
        ];

        // å¾Œã‚ã‹ã‚‰å¥èª­ç‚¹ã‚’æ¢ã—ã¦ã€ãã“ã§åˆ‡ã‚Šè©°ã‚ã‚‹
        let truncatedText = text;
        let foundPunctuation = false;

        // å„å¥èª­ç‚¹ã®ä½ç½®ã‚’æ¢ã™
        for (let pos = text.length - 1; pos >= 0; pos--) {
          const char = text[pos];

          // å¥èª­ç‚¹ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€ãã®ç›´å¾Œã¾ã§ã‚’å–å¾—
          if (punctuationMarks.includes(char)) {
            truncatedText = text.substring(pos + 1).trim();

            // ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (truncatedText.length === 0) {
              continue;
            }

            // è¡Œæ•°ã‚’æ¸¬å®š
            textElement.textContent = truncatedText;
            const lines = getLineCount();

            if (lines <= MAX_LINES) {
              foundPunctuation = true;
              console.log(
                `Truncated at punctuation '${char}' (position ${pos}). Result: "${truncatedText}"`
              );
              return truncatedText;
            }
            // ã¾ã é•·ã™ãã‚‹å ´åˆã¯ã€ã•ã‚‰ã«å‰ã®å¥èª­ç‚¹ã‚’æ¢ã™
          }
        }

        // å¥èª­ç‚¹ã§åˆ‡ã‚Œãªã‹ã£ãŸå ´åˆã€æ–‡å­—å˜ä½ã§åˆ‡ã‚Šè©°ã‚ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        if (!foundPunctuation) {
          console.log(
            "No suitable punctuation found. Using character-based truncation..."
          );
          for (let i = 1; i < text.length; i++) {
            truncatedText = text.substring(i);
            textElement.textContent = truncatedText;

            if (getLineCount() <= MAX_LINES) {
              console.log(`Truncated ${i} chars from beginning`);
              return truncatedText;
            }
          }
        }

        // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€å¾Œã®1æ–‡å­—ã‚’è¿”ã™
        return text.substring(text.length - 1);
      }

      /**
       * ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’æ›´æ–°ã—ã€å¹ãå‡ºã—ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
       */
      function updateFontSize(text) {
        // ãƒ†ã‚­ã‚¹ãƒˆãŒå¿…è¦ã«å¿œã˜ã¦åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹
        const truncatedText = truncateTextToMaxLines(text);
        currentText = truncatedText;

        // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¦é©ç”¨
        const fontSize = calculateFontSize(truncatedText);
        textElement.style.fontSize = fontSize + "px";
        textElement.textContent = truncatedText;

        // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§è¡Œæ•°ã‚’è¨ˆç®—ã—ã¦å¹ãå‡ºã—ç”»åƒã‚’é¸æŠï¼ˆDOMãŒæ›´æ–°ã•ã‚ŒãŸå¾Œï¼‰
        requestAnimationFrame(() => {
          const lines = getLineCount();
          const newBubbleImage = selectBubbleImage(lines);

          // å¹ãå‡ºã—ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆ
          if (bubbleImage.src !== window.location.origin + newBubbleImage) {
            bubbleImage.src = newBubbleImage;
            console.log(`Switched to: ${newBubbleImage} (${lines} lines)`);
          }

          console.log(
            `Text: ${
              truncatedText.length
            } chars, Font: ${fontSize}px, Lines: ${lines}, Device: ${
              isMobile() ? "Mobile" : "Desktop"
            }`
          );
        });
      }

      // ç”»åƒã®é«˜ã•ã‚’å–å¾—ï¼ˆç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ãŸã³ã«æ›´æ–°ï¼‰
      bubbleImage.onload = function () {
        bubbleImageHeight = bubbleImage.offsetHeight;
        // ç¾åœ¨ã®ä½ç½®ã§ãƒ†ã‚­ã‚¹ãƒˆä½ç½®ã‚’æ›´æ–°
        const currentY = parseInt(bubbleImage.style.top) || 0;
        updateTextPosition(currentY);
        console.log(`Bubble image loaded. Height: ${bubbleImageHeight}px`);
      };

      // æ¥ç¶šçŠ¶æ…‹ã®ç®¡ç†
      socket.on("connect", () => {
        console.log("Connected to server");
        console.log(
          `Device mode: ${
            isMobile() ? "Mobile (center-fixed)" : "Desktop (face detection)"
          }`
        );
        statusElement.textContent = "æ¥ç¶šæ¸ˆã¿";
        statusElement.className = "connected";
        setTimeout(() => {
          statusElement.style.display = "none";
        }, 2000);
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from server");
        statusElement.textContent = "æ¥ç¶šåˆ‡æ–­";
        statusElement.className = "disconnected";
        statusElement.style.display = "block";
      });

      // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
      socket.on("update_text", (data) => {
        console.log("Received text:", data.text);

        // updateFontSizeãŒåˆ‡ã‚Šè©°ã‚ã¨currentTextã®æ›´æ–°ã‚’è¡Œã†
        updateFontSize(data.text);

        bubbleImage.classList.add("visible");
        textContainer.classList.add("visible");
      });

      // ä½ç½®æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
      socket.on("update_position", (data) => {
        console.log("Received position:", data.y);
        updateTextPosition(data.y);
      });

      // éè¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆ
      socket.on("hide_bubble", () => {
        console.log("Hiding bubble");
        bubbleImage.classList.remove("visible");
        textContainer.classList.remove("visible");
      });

      // è¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆ
      socket.on("show_bubble", () => {
        console.log("Showing bubble");

        // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã€åˆæœŸä¸­å¤®ä½ç½®ã‚’è¨­å®š
        if (isMobile()) {
          const viewportHeight = window.innerHeight;
          const bubbleHeight = bubbleImage.offsetHeight || bubbleImageHeight;
          const centerY = viewportHeight * 0.4;
          const initialY = centerY - bubbleHeight / 2;
          updateTextPosition(initialY);
        }

        bubbleImage.classList.add("visible");
        textContainer.classList.add("visible");
      });

      // ä½ç½®æ›´æ–°é–¢æ•°
      function updateTextPosition(newY) {
        const bubbleHeight = bubbleImage.offsetHeight || bubbleImageHeight;
        const viewportHeight = window.innerHeight;

        let finalY;

        // ãƒ¢ãƒã‚¤ãƒ«: å›ºå®šä¸­å¤®ä½ç½®ã‚’ä½¿ç”¨ï¼ˆé¡”æ¤œå‡ºã‚’ç„¡è¦–ï¼‰
        if (isMobile()) {
          // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®40%ã®ä½ç½®ã«é…ç½®ï¼ˆä¸­å¤®ã‚ˆã‚Šã‚„ã‚„ä¸Šï¼‰
          const centerY = viewportHeight * 0.4;
          // å¹ãå‡ºã—ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«é…ç½®
          finalY = centerY - bubbleHeight / 2;
          console.log(`Mobile mode: Fixed position at 40% (Y=${finalY})`);
        }
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: é¡”æ¤œå‡ºçµæœã‚’ã‚¯ãƒ©ãƒ³ãƒ—ã—ã¦ä½¿ç”¨
        else {
          // Yä½ç½®ã‚’ã‚¯ãƒ©ãƒ³ãƒ—ã—ã¦ç”»é¢å†…ã«åã‚ã‚‹
          finalY = Math.max(0, Math.min(viewportHeight - bubbleHeight, newY));
          console.log(
            `Desktop mode: Face detection Y=${newY}, clamped=${finalY}`
          );
        }

        // ä½ç½®ã‚’é©ç”¨
        bubbleImage.style.top = finalY + "px";

        // å¹ãå‡ºã—ç”»åƒã®ç¨®é¡ã«å¿œã˜ã¦ãƒ†ã‚­ã‚¹ãƒˆä½ç½®ã‚’èª¿æ•´
        let textYOffset;
        if (bubbleImage.src.includes("speech-bubble2.png")) {
          // 2è¡Œç”¨: ä¸­å¤®
          textYOffset = bubbleHeight / 2;
        } else if (bubbleImage.src.includes("speech-bubble3.png")) {
          // 3è¡Œä»¥ä¸Šç”¨: ä¸­å¤®
          textYOffset = bubbleHeight / 2;
        } else {
          // 1è¡Œç”¨: å°‘ã—ä¸Šï¼ˆ40%ã®ä½ç½®ï¼‰
          textYOffset = bubbleHeight * 0.4;
        }

        const textY = finalY + textYOffset;
        textContainer.style.top = textY + "px";
      }

      // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
      window.addEventListener("resize", () => {
        containerHeight = window.innerHeight;
        if (bubbleImage.complete) {
          bubbleImageHeight = bubbleImage.offsetHeight;
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ä½ç½®ã‚’å†è¨ˆç®—
        if (isMobile()) {
          // ãƒ¢ãƒã‚¤ãƒ«: 40%ä½ç½®ã«å†ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
          const centerY = window.innerHeight * 0.4;
          const newY = centerY - bubbleImageHeight / 2;
          updateTextPosition(newY);
        } else {
          // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: ç¾åœ¨ã®é¡”æ¤œå‡ºä½ç½®ã‚’å†ã‚¯ãƒ©ãƒ³ãƒ—
          const currentY = parseInt(bubbleImage.style.top) || 0;
          updateTextPosition(currentY);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—
        if (currentText) {
          updateFontSize(currentText);
        }
      });

      // åˆæœŸçŠ¶æ…‹ã§æ¥ç¶šç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      socket.emit("client_ready", {
        screen_width: window.innerWidth,
        screen_height: window.innerHeight,
      });

      // è¨€èªé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‡¦ç†
      const languageModal = document.getElementById("language-modal");
      const sourceLangSelect = document.getElementById("source-lang");
      const targetLangSelect = document.getElementById("target-lang");
      const startButton = document.getElementById("start-button");
      const loadingMessage = document.getElementById("loading-message");

      // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      startButton.addEventListener("click", () => {
        const sourceLang = sourceLangSelect.value;
        const targetLang = targetLangSelect.value;

        // åŒã˜è¨€èªãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if (sourceLang === targetLang) {
          alert("ç¿»è¨³å…ƒã¨ç¿»è¨³å…ˆã«ç•°ãªã‚‹è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        startButton.disabled = true;
        loadingMessage.classList.add("visible");

        // ã‚µãƒ¼ãƒãƒ¼ã«è¨€èªé¸æŠã‚’é€ä¿¡
        socket.emit("select_language", {
          source_lang: sourceLang,
          target_lang: targetLang,
        });
      });

      // ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
      socket.on("system_started", (data) => {
        console.log("System started:", data);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        languageModal.classList.add("hidden");

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        loadingMessage.classList.remove("visible");
        startButton.disabled = false;

        console.log(
          `Language set to: ${data.source_lang} -> ${data.target_lang}`
        );
      });
    </script>
  </body>
</html>
